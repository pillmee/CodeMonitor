# Module Spec: Frontend Visualization

## 1. 개요 (Overview)
이 모듈은 소스 코드 라인수 변화를 사용자에게 시각적으로 보여주는 현대적인 웹 대시보드입니다. 다중 저장소 비교, 통합 뷰, 실시간 작업 모니터링 기능을 제공하며, 프리미엄 다크 테마 디자인을 지향합니다.

## 2. 디자인 및 레이아웃 (Layout)

### 2.1. 컨셉: Premium Dark Mode
- **색상**: Deep Charcoal 배경 (#121212), Neon Blue/Violet 주요 포인트.
- **스타일**: 유리모피즘(Glassmorphism) 효과의 카드 UI, 부드러운 트랜지션.
- **폰트**: Inter 또는 Outfit (Google Fonts).

### 2.2. 페이지 구조
- **Header**: 로고, 전역 설정 아이콘, 현재 전체 저장소 수 요약.
- **Sidebar**: 등록된 저장소 목록 (분석중/완료 상태 표시), 저장소 추가 버튼.
- **Main Chart Area**: 
  - `Multi-Line Chart`: 개별 저장소 비교용.
  - `Stacked/Area Chart`: 전체 코드량 통합용.
- **Summary Cards**: 현재 총 라인수, 24시간 증감량, 분석 속도 등.

## 3. 핵심 기능 (Features)

### 3.1. 인터랙티브 차트 (Chart.js)
- **Multi-Dataset**: 여러 저장소 데이터를 각각의 선으로 그래프화.

#### 3.1.1. Time Scaling & Interaction
- **Adaptive Scaling**: X축 가시 범위에 따라 눈금 단위를 **실시간**으로 자동 전환함. (1개월 이내: 일 단위, 1개월~1년: 주 단위, 1년 초과: 월 단위)
- **Panning (이동)**: 마우스 좌우 드래그를 통해 시간 축(X축) 이동. 마우스 왼쪽 이동 시 과거(Past) 데이터로, 오른쪽 이동 시 최근(Future) 데이터로 이동하는 직관적인 조작 방식(Natural Panning)을 제공함. 렌더링 성능 최적화를 통해 60fps 수준의 끊김 없는 조작감을 보장함.
- **Zooming (확대/축소)**: 마우스 스크롤 휠 또는 핀치 줌 지원. `Ctrl` 키(또는 Mac 핀치 제스처)와 함께 조작해야만 줌이 작동하며, 조작 감도 조정을 통해 터치패드에서도 정밀한 제어가 가능함.

#### 3.1.2. Zoom & Boundary Limits
- **최소 범위**: 7일 (과도한 확대 방지). 7일 이상으로 확대하지 않음.
- **최대 범위 (줌 아웃 제한)**: 사용자가 선택한 Time Range에 맞춤. 예를 들어 "Last 3 Years"를 선택했다면 3년 이상 축소할 수 없음.
- **우측(미래) 제한**: X축의 최우측(max)은 항상 **현재 시점**으로 고정되어 미래 영역이 표시되지 않음.
- **좌측(과거) 제한**: X축의 최좌측(min)은 **2000년 1월 1일**로 고정됨. 마우스 드래그, 트랙패드 스와이프, 줌 플러그인 모두에서 2000년 이전으로 이동할 수 없음.

#### 3.1.3. Time Range 옵션
- 드롭다운 선택지: **7일, 30일, 90일, 1년, 2년, 3년, 5년, 7년, 10년, 15년, 20년**.
- "전체 보기(All Time)" 옵션은 제공하지 않음.
- 선택된 범위는 API 데이터 패칭 및 최대 줌 아웃 제한에 모두 적용됨.

#### 3.1.4. Trackpad & Touch Interaction (macOS)
- **줌 오작동 방지 (Modifier Key)**: 맥북 트랙패드에서 좌우 스와이프 시 의도하지 않은 줌이 발생하는 것을 방지하기 위해, 줌 조작에는 반드시 `Ctrl` 키(또는 핀치 제스처)가 수반되어야 함 (`zoom.wheel.modifierKey: 'ctrl'`).
- **트랙패드 이동 (Swipe Pan)**: `Ctrl` 키 없이 트랙패드를 좌우로 스와이프하면 차트가 좌우로 이동(Pan)함. 이 동작은 자연스러운 스크롤 방향을 따름.
- **브라우저 네비게이션 차단**: 차트 영역 위에서의 좌우 스와이프가 **브라우저의 '뒤로 가기/앞으로 가기' 제스처로 오인되지 않도록** `e.preventDefault()`를 사용하여 이벤트를 차단함. React의 `onWheel`은 passive 리스너로 등록되어 `preventDefault()`가 무시되므로, **네이티브 DOM `addEventListener`를 `{ passive: false }` 옵션으로 등록**하여 처리함.
- **디바운싱 상태 동기화**: 트랙패드 스크롤 중에는 차트 엔진을 직접 제어하고, 조작이 **500ms 동안 멈추면** React 상태를 비동기적으로 동기화하여 요약 카드 등 연관 UI를 업데이트함.

#### 3.1.5. Date Formatting & Tick Visibility
- **날짜 형식**: X축 표시 시 기본적으로 `MM/dd` 형식을 사용하되, **X축의 첫 번째 일자** 및 **연도가 바뀌는 시점의 첫 번째 일자**에는 `yyyy/MM/dd` 형식으로 연도를 병기함.
- **라벨 기울임**: 가독성을 위해 모든 일자 표기는 항상 **45도 기울어진 형태**로 표시하며 사선(`/`) 구분자를 사용함.
- **30일 미만 범위 전체 날짜 표시**: 그래프 윈도우에 나타나는 기간이 **30일보다 작을 경우**, X축에 해당 기간의 **모든 날짜가 빠짐없이** 표시되어야 함 (`ticks.autoSkip: false`). 30일 이상의 범위에서는 자동 건너뛰기(`autoSkip: true`)를 통해 가독성을 유지함.

#### 3.1.6. State & Performance
- **Maintain Zoom State**: 백그라운드 데이터 패칭(분석 상태 업데이트 등) 시에도 사용자가 설정한 현재의 줌(Zoom) 및 팬(Pan) 상태가 리셋되지 않고 유지되어야 함.
- **Decimation**: LTTB 알고리즘 기반의 고밀도 데이터 포인트 샘플링을 통해 렌더링 성능 최적화.
- **60fps 인터랙션**: 확대/축소 및 이동 조작 중에는 React 상태 업데이트를 지연시키고, Chart.js 인스턴스를 직접 제어하여 애니메이션 없는 즉시 렌더링(`chart.update('none')`)을 수행함. 조작 종료 시점에만 상태를 동기화하여 60fps 수준의 반응성을 보장함.

### 3.2. 데이터 무결성 (Data Integrity)
- **프론트엔드 정렬**: 백엔드에서 수신한 데이터의 정렬 상태와 무관하게, 프론트엔드에서 X축(타임스탬프) 기준으로 **강제 오름차순 정렬** (`.sort((a, b) => a.x - b.x)`)을 수행함. 이를 통해 선이 겹치는 "낙서(Scribble)" 현상을 방지하고, Chart.js의 Decimation 플러그인이 정상 작동하기 위한 필수 조건인 '단조 증가(Monotonic) 데이터'를 보장함.

### 3.3. 일간 통계 집계 (Daily Aggregation)
- **백엔드 SQL 처리**: Git 커밋 이력은 **하루 단위**로 집계함. 동일 저장소의 동일 날짜에 여러 커밋이 존재할 경우, **해당 날짜의 마지막 레코드**만 선택하여 반환함.
- **날짜 추출 방식**: SQLite의 `DATE()` 함수는 특정 타임존 형식 (예: `+0900`)을 인식하지 못하므로, 문자열 자르기(`SUBSTR(timestamp, 1, 10)`)를 사용하여 타임존에 관계없이 `YYYY-MM-DD` 형식의 날짜를 정확하게 추출함.
- **효과**: 데이터 전송량 및 렌더링 포인트 수를 대폭 줄여 API 응답 시간과 차트 성능을 향상시킴.

### 3.4. 저장소 선택 및 그래프 모드
- **All Repositories (합산 보기)**: 사이드바에서 "All Repositories"를 클릭하면, 등록된 **모든 저장소의 LOC를 일별로 합산**하여 **단일 선 그래프**로 표시함. 클릭 시 개별 저장소의 체크박스 선택은 모두 **자동 해제**됨.
- **개별 저장소 다중 선택**: 각 저장소에 **체크박스**를 제공하여 여러 저장소를 동시에 선택/해제할 수 있음. 선택된 저장소들의 개별 선이 **겨쳐서(overlay)** 표시됨.
- **모드 전환**: "All Repositories"를 클릭하면 합산 모드(viewMode: `all`)로, 개별 체크박스를 조작하면 선택 모드(viewMode: `selected`)로 자동 전환됨.

#### 3.4.1. 합산 로직 (Carry-Forward Aggregation)
- 여러 저장소의 데이터를 합산할 때, 각 저장소의 데이터가 서로 다른 날짜에 존재할 수 있음. 특정 날짜에 한 저장소의 데이터가 없을 경우, 해당 저장소의 **마지막으로 알려진 값(last known value)**을 유지하여 합산에 포함함.
- 이를 통해 한 저장소의 데이터가 누락된 날짜에서 합산 그래프가 급격히 떨어지는 현상을 방지함.
- 날짜 그룹핑 시 UTC 변환이 아닌 **로컬 날짜 기준**으로 처리하여 타임존 오프셋으로 인한 날짜 엔렸을 방지함.

### 3.5. Summary Cards (통계 카드)
- **Total LOC**: 현재 선택된 저장소(들)의 최신 총 코드 라인수. `all` 모드에서는 모든 저장소의 최신 LOC를 합산.
- **Net Change**: 선택된 기간 동안의 코드 라인수 변화량.
- **통계값 계산 방식**: 합산 그래프와 별도로, **개별 저장소 데이터(rawDatasets)**를 기반으로 per-repo로 계산 후 합산함. 이는 합산 그래프의 첫 포인트가 일부 저장소만 포함하는 문제를 회피하여 정확한 Net Change를 보장함.
- `all` 모드에서는 카드 제목에 "(Total)" 접미사를 표시하여 합산 값임을 명시함.

### 3.6. 저장소 관리 UI
- **Add Repo Modern Modal**: 로컬 경로 입력 및 별칭 설정.
- **Task Progress Bar**: 백필(Backfill) 진행 상황을 애니메이션으로 표시.

### 3.7. 브라우저 설정 보존 (Persistence)
- **localStorage 활용**: 다음 설정값들을 브라우저 로컬 스토리지에 저장하여 새로고침이나 재방문 시에도 유지함.
    - `cm_view_mode`: 그래프 모드 (`all` 또는 `selected`)
    - `cm_selected_repos`: 선택된 저장소 ID 목록 (JSON 배열)
    - `cm_days`: 선택된 Time Range (일 수)
    - `cm_chart_range`: 사용자가 직접 조정한 차트의 줌/팬 구간 (`{min, max}`)
- **초기 로드 로직**: 앱 초기화 시 스토리지에서 값을 읽어 상태를 설정함.
- **예외 처리**: `Time Range` 드롭다운을 통해 범위를 명시적으로 변경할 경우, 저장된 `cm_chart_range`보다 드롭다운 설정을 우선하여 차트 윈도우를 새 범위로 강제 리셋함.

## 4. 기술 스택 (Technical Stack)
- **Bundler**: Vite
- **UI Framework**: React (or Vanilla JS)
- **Styling**: Vanilla CSS (CSS Variables 활용)
- **Chart Library**: `Chart.js` + `chartjs-plugin-zoom` + `chartjs-adapter-date-fns` + `chartjs-plugin-decimation`
- **API Client**: `Axios` 또는 `Fetch API`

## 5. 데이터 패칭 전략 (Data Fetching)
- **Initial Load**: 저장소 목록 및 설정값 조회. 최초 진입 시 그래프 가시 범위(Window)를 **현재일 기준 최근 7일(예: 22일~28일)**로 고정하여 일주일치 흐름을 한눈에 보여줌. (데이터가 없는 날짜도 포함하여 윈도우 유지)
- **Periodic Update**: 백필(Backfill) 진행 상황 폴링. 차트 줌 상태를 유지하기 위해 기존 데이터 셋을 전체 교체하는 대신 부분 업데이트하거나, 차트 컴포넌트의 불필요한 재렌더링을 억제함.
- **On Demand**: 저장소 선택 변경 시 해당 데이터 즉시 패칭 및 뷰 업데이트.
